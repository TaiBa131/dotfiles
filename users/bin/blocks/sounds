#!/usr/bin/env python3
import sys, subprocess, os, re, urllib.request
FNULL = open(os.devnull, 'w')
HOME=os.path.expanduser('~')
BUTTON=os.environ.get('BLOCK_BUTTON')

def mpdradio(TYPE='normal'):
    def gettitle():
        if TYPE == 'pianorama':
            FORMAT='%title%'
        else:
            FORMAT='[%artist% - ]|[%artist% - ]&%title%'
        TITLE=subprocess.check_output(['mpc','-f',FORMAT,'current'],text=True).strip('\n')
        return TITLE
    if BUTTON is None:
        print(gettitle())
    elif BUTTON == '1':
        print(gettitle())
        subprocess.run(['i3-msg','-q','--','exec','$TERMINAL','-e','ncmpcpp'])
    elif BUTTON == '3':
        subprocess.run(['mpc','-q','update'])
        subprocess.run(['mpc','-q','clear'])
        subprocess.run(['mpc','-q','add','/'])
    else:
        TITLE=gettitle()
        print(TITLE)
        f=open(f'{HOME}/.calcurse/notes/songstodownload.txt','a')
        f.write(TITLE+'\n')
        f.close()
        NOTIFICATION='ðŸŽ¶ Added to songstodownload.txt'
        subprocess.run(['notify-send',NOTIFICATION,TITLE])
    exit()

def misk():
    def gettitle():
        f=urllib.request.urlopen('http://www.misk.art/live')
        HTML=f.read()
        HTML=HTML.decode('utf8').split('\n')
        f.close()
        TITLE=None
        ARTIST=None
        for line in HTML:
            if TITLE is None and 'pl-item-title' in line:
                TITLE=re.sub('.*<.+>(.+)<.+>.*',r'\1',line).capitalize()
            if ARTIST is None and 'pl-item-artist' in line:
                ARTIST=re.sub('.*<.+>(.+)<.+>.*',r'\1',line).capitalize()
            if TITLE is not None and ARTIST is not None:
                break
        FULL=ARTIST + ' - ' + TITLE
        return FULL
    if BUTTON is None:
        print(gettitle())
    elif BUTTON in ('2','4','5'):
        TITLE=gettitle()
        print(TITLE)
        f=open(f'{HOME}/.calcurse/notes/songstodownload.txt','a')
        f.write(TITLE+'\n')
        f.close()
        NOTIFICATION='ðŸŽ¶ Added to songstodownload.txt'
        subprocess.run(['notify-send',NOTIFICATION,TITLE])
    elif BUTTON == '3':
        subprocess.run(['pkill','-f','mpv http://live.misk.tn:8000/stream'])
    exit()

def other(TYPE,FILE):
    def mainfunction(NAME,FILE):
        if BUTTON is None:
            print('Playing',NAME)
        elif BUTTON == '3':
            subprocess.run(['pkill','-f',FILE])
        exit()
    if TYPE == 'exam':
        NAME='Exam noise'
        mainfunction(NAME,FILE)
    elif TYPE == 'thundernoise':
        NAME='Thunder noise'
        mainfunction(NAME,FILE)
    elif TYPE == 'brownnoise':
        NAME='Brownian noise'
        mainfunction(NAME,FILE)
    elif TYPE == 'lofimix':
        NAME='LoFi HipHop mix'
        mainfunction(NAME,FILE)
    elif TYPE == 'lofiradio':
        NAME='LoFi HipHop radio'
        mainfunction(NAME,FILE)

###---mpd radios---###
RADIO=subprocess.check_output(['mpc','-f','%file%'],text=True)
if re.match('^https://listen.moe/stream',RADIO):
    mpdradio()
elif re.match('^https://lainon\.life/radio/.*\.ogg',RADIO):
    mpdradio()
elif re.match('^http://stream.pianoramaradio.ru',RADIO):
    mpdradio(TYPE='pianorama')

###---misk radio---###

RADIO = 'mpv http://live.misk.tn:8000/stream'
if subprocess.run(['pgrep','-f',RADIO],stdout=FNULL).returncode == 0:
    misk()

###---other radio---###

RADIO = 'mpv --loop-file=inf /home/iheb/other/sound/examinationtime.mp3'
if subprocess.run(['pgrep','-f',RADIO],stdout=FNULL).returncode == 0:
    other('exam',RADIO)

RADIO = 'mpv --loop-file=inf /home/iheb/other/sound/thundernoise.mp3'
if subprocess.run(['pgrep','-f',RADIO],stdout=FNULL).returncode == 0:
    other('thundernoise',RADIO)

RADIO = 'mpv --loop-file=inf /home/iheb/other/sound/brownnoise.mp3'
if subprocess.run(['pgrep','-f',RADIO],stdout=FNULL).returncode == 0:
    other('brownnoise',RADIO)

RADIO = 'mpv --save-position-on-quit --loop-file=inf /home/iheb/other/sound/lofihiphopmix.mp3'
if subprocess.run(['pgrep','-f',RADIO],stdout=FNULL).returncode == 0:
    other('lofimix',RADIO)

RADIO = 'mpv --no-vid https://www.youtube.com/watch\?v=hHW1oY26kxQ --ytdl-format=93'
if subprocess.run(['pgrep','-f',RADIO],stdout=FNULL).returncode == 0:
    other('lofiradio',RADIO)

