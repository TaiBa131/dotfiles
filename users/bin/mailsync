#!/usr/bin/env python3

import sys, subprocess, os, re

FNULL = open(os.devnull, 'w')
HOME=os.path.expanduser('~')
USER=os.environ['USER']
DATE = subprocess.check_output(['date'],text=True)

if os.path.isdir(f'{HOME}/.local/share/password-store'):
	os.environ['PASSWORD_STORE_DIR'] = f'{HOME}/.local/share/password-store'
if subprocess.run(['pgrep','-u',USER],stdout=FNULL,stderr=FNULL).returncode != 0:
	print(f'{USER} is not logged in; sync will not run')
	exit()
if subprocess.run(['pgrep','-x','mbsync'],stdout=FNULL,stderr=FNULL).returncode == 0:
	print('mbsync is already running')
	exit()
if subprocess.run(['ping','-q','-c','1','1.1.1.1'],stdout=FNULL,stderr=FNULL).returncode != 0:
	print('No internet connection detected.')
	exit()

def notify(account,newcount):
    subprocess.run(f'notify-send "Mailsync" "ðŸ“¬ {newcount} new mail(s) in {account} account."',shell=True)

def getfrom(file):
    FROM=subprocess.check_output(f'awk "/^From: / && ++n ==1,/^\<.*\>:/" "{file}"',shell=True,text=True)
    FROM=subprocess.Popen('perl -CS -MEncode -ne \'print decode("MIME-Header", $_)\'',shell=True,text=True,stdin=subprocess.PIPE,stdout=subprocess.PIPE).communicate(FROM)[0]
    FROM=subprocess.Popen('awk \'{ $1=""; if (NF>=3)$NF=""; print $0 }\' ',shell=True,text=True,stdin=subprocess.PIPE,stdout=subprocess.PIPE).communicate(FROM)[0]
    FROM=subprocess.Popen('sed \'s/^[[:blank:]]*[\\"\'\\\'\'\\<]*//;s/[\\"\'\\\'\'\\>]*[[:blank:]]*$//\'',shell=True,text=True,stdin=subprocess.PIPE,stdout=subprocess.PIPE).communicate(FROM)[0].strip('\n')
    return FROM

def getsubject(file):
    SUBJECT=subprocess.check_output(f'awk "/^Subject: / && ++n == 1,/^\<.*\>: / && ++i == 2" "{file}" ',shell=True,text=True).split('\n')[0]
    SUBJECT=subprocess.Popen('perl -CS -MEncode -ne \'print decode("MIME-Header", $_)\'',shell=True,text=True,stdin=subprocess.PIPE,stdout=subprocess.PIPE).communicate(SUBJECT)[0]
    SUBJECT=re.sub('^Subject: ','',SUBJECT)
    SUBJECT=re.sub('^{[[:blank:]]*[\"\'\'\'\<]*//;s/[\"\'\'\'\>]*[[:blank:]]*$','',SUBJECT).strip('\n')
    return SUBJECT


def syncandnotify(account):
    print('Syncing',account)
    subprocess.run(['mbsync',account],stdout=FNULL,stderr=FNULL)
    new = subprocess.Popen(f'find "{HOME}/.local/share/mail/{account}/INBOX/new/" "{HOME}/.local/share/mail/{account}/Inbox/new/" "{HOME}/.local/share/mail/{account}/inbox/new/" -type f -newer "{HOME}/.config/mutt/.mailsynclastrun"',shell=True,text=True,stderr=FNULL,stdout=subprocess.PIPE).communicate()[0].split()
    newcount = len(new)
    if newcount > 0:
        notify(account,newcount)
        for file in new:
            FROM = getfrom(file)
            SUBJECT = getsubject(file)
            subprocess.run(f'notify-send "ðŸ“§ {FROM}" "{SUBJECT}"',shell=True,stdout=FNULL,stderr=FNULL)


if len(sys.argv) != 1:
    accounts=sys.argv
    accounts.remove(accounts[0])
else:
    accounts = ''
    f=open(f'{HOME}/.mbsyncrc','r')
    for line in f:
        if re.match('^Channel',line,flags=re.M):
            accounts = accounts + line.split()[1] + '\n'
    accounts=accounts.split()

for account in accounts:
    syncandnotify(account)

subprocess.run(['pkill','-RTMIN+12','i3blocks'],stdout=FNULL,stderr=FNULL)
subprocess.run(['notmuch','new'],stdout=FNULL,stderr=FNULL)

f=open(f'{HOME}/.config/mutt/.mailsynclastrun','w')
f.write(f'{DATE}')
f.close()
